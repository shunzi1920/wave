INTSourceChangelist:2602760
Availability: Public
Title:폴리지, 인스턴싱된 메시
Crumbs:%ROOT%, Engine
Description:Foliage, 폴리지는 다른 지오메트리의 표면 위에 인스턴싱된 메시를 렌더링하여 땅을 뒤덮는 초목과 같은 효과를 내는 데 사용되는 시스템입니다.

[VAR:Topic]
[OBJECT:Topic]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[VAR:TopicCompact]
[OBJECT:TopicCompact]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[REGION:header_img]
![Foliage Tool](Foliage_Banner.png)(w:900)
[/REGION]

[TOC(start:2 end:2)]

[EXCERPT:Intro]

폴리지(Foliage) 시스템은 랜드스케이프 액터나 다른 스태틱 메시 액터나 레거시 터레인 액터에 스태틱 메시 세트를 빠르게 칠하거나 지울 수 있는 시스템입니다. 이러한 메시들은 하드웨어 인스턴싱을 사용하여 렌더링되는 일괄(batch) 그룹 속에 자동으로 묶이는데, 이는 단 하나의 드로 콜에 다수의 인스턴스를 렌더링할 수 있다는 뜻입니다.

[/EXCERPT:Intro]

폴리지 툴의 실전 예제는 [](Resources\ContentExamples\Landscapes) 콘텐츠 예제의 [](Resources\ContentExamples\Landscapes\1_3) 섹션을 확인하시기 바랍니다.

## 폴리지 편집 모드

폴리지 툴을 사용하려면, **모드** 패널의 **Foliage** (폴리지) 버튼을 (Shift+4) 누릅니다.

![FoliageMode.png](FoliageMode.png)
 
폴리지 편집 모드 창이 **모드** 패널에 나타납니다.

![FoliageWindowInitial.png](FoliageWindowInitial.png)



## 메시 목록

처음엔 목록에 나열되는 폴리지 메시가 없습니다. 먼저 콘텐츠 브라우저에서 스태틱 메시를 직접 끌어 **Drag Static Meshes from the Content Browser into this area** (콘텐츠 브라우저에서 스태틱 메시를 끌어 여기에 놓으세요.) 라는 검정색 바에 놓아 주어야 폴리지를 칠할 수 있게 됩니다.

![](Foliage_TextBar.png)

[REGION:tip]
첫 스태틱 메시를 검정색 바 아래 빈 공간에 놓지 마세요. 먼저 검정색 바 바로 위에 놓아야 합니다.
[/REGION]

[REGION:note]
첫 스태틱 메시를 목록에 추가한 이후에는, 다른 스태틱 메시를 폴리지 편집 모드 창으로 끌어와, 목록의 기존 메시 위에 놓는 것으로 추가할 수 있습니다.
[/REGION]

<!----
![FoliageWindowDrag.png](FoliageWindowDrag.png)
---->

메시 목록의 스태틱 메시는 세 가지 모드 중 하나로 표시 가능합니다:
* **Hide Details** (디테일 숨김) - 모든 파라미터와 프로퍼티를 숨겨, 전체 목록을 더욱 쉽게 확인할 수 있습니다.
	![FoliageWindowAfterDrag.png](FoliageWindowAfterDrag.png)
* **Show Painting Settings** (페인팅 세팅 표시) - 메시가 레벨에 어떻게 배치되는지에 영향을 끼치는 파라미터를 표시합니다 (스태틱 메시 추가시의 기본 모드입니다).

	![Moliage Painting Settings](Foliage_MeshParams.png)
* **Show Instance Settings** (인스턴스 세팅 표시) - 이미 레벨에 배치된 인스턴스 제어를 위한 파라미터를 표시합니다.
	![Mesh Instance Settings](Foliage_ShowInstance.png)

메시가 **페인팅 세팅** 또는 **인스턴스 세팅** 모드에 있는 경우, 메시 아이콘 위에 세 버튼도 나타납니다.

| 항목 | 설명 |
| --- | --- |
| ![](Shared/Icons/icon_assign_left_16x.png) | 이 버튼은 현재 레벨에 이미 놓인 모든 메시 인스턴스를 현재 콘텐츠 브라우저에 선택된 스태틱 메시로 싹 갈음합니다. |
| ![](Shared/Icons/icon_delete.png)(w:16) | 이 버튼은 메시 목록에서 메시를 없앨 뿐 아니라, **현재 레벨에 이미 놓여 있는 이 메시의 인스턴스도 전부** 없앱니다. |
| ![](Shared/Icons/icon_MeshPaint_Find_16x.png) | 이 버튼은 콘텐츠 브라우저에서 스태틱 메시 위치를 찾아 보여줍니다. |

### 메시 목록에 선택된 메시

**Meshes** (메시) 목록에 있는 메시를 클릭하면 메시를 선택하고 해제할 수 있습니다 (주황색이 선택입니다). 레벨 에디터 뷰포트에서 메시를 생성 또는 지울 때, **메시** 목록에 현재 선택된 메시만 영향을 받습니다. 레벨에 이미 있는 다른 스태틱 메시의 폴리지 인스턴스는 어떻게든 영향받지 않으며, **메시** 목록 항목 중 선택 해제된 인스턴스도 레벨에 추가되지 않습니다.

다음 예제는 두 개의 메시가 선택된 것을 보여줍니다. **SM_Rock** 메시는 선택되지도 않은 것처럼, 레벨에 칠해지지도 지워지지도 않습니다.

![Two Meshes Selected](Foliage_MeshList.png)

#### 브러시 세팅

**메시** 목록 위에, 메시 편집 툴에는 현재 선택된 폴리지 툴에 관련된 프로퍼티가 표시됩니다 (모든 폴리지 툴에 모든 세팅이 전부 표시되지는 않습니다).

| 항목 | 설명 |
| ---- | ----------- |
| **Brush Size** | 브러시 크기 - 언리얼 유닛 단위의 크기입니다.  
| **Paint Density** | 칠하기 밀도 - [INCLUDE:Engine/Foliage#PaintDensity] |
| **Erase Density** | 지우기 밀도 - [INCLUDE:Engine/Foliage#EraseDensity] |
| **Filter** | 필터 - [INCLUDE:Engine/Foliage#Filter] |

<!---
[EXCERPT:PaintDensity]
**Ctrl+클릭** 으로 인스턴스를 칠할 때 목표로 삼을 밀도입니다.
* 이 값의 범위는 0 에서 1 까지로, 1 은 각 메시에 대해 메시 프로퍼티에 나열된 최대 밀도로 메시 인스턴스를 칠합니다 (아래 참고).
* 브러시 내 메시의 밀도가 이보다 크면, 메시가 추가되지 않습니다.
[/EXCERPT:PaintDensity]
--->


<!---
[EXCERPT:EraseDensity]
**Ctrl+Shift+클릭** 으로 인스턴스를 지울 때 목표로 삼을 밀도입니다.
* 이 값의 범위는 0 에서 1 까지로, 0 은 메시가 없음을 나타냅니다. 이 지우기 밀도보다 메시가 적은 경우, 메시를 더이상 지우지 않습니다.
* 이미 칠해진 메시 인스턴스를 완전히 지우지는 않으면서 연하게 만들 수 있습니다.
[/EXCERPT:EraseDensity]
--->

<!---
[EXCERPT:Filter]
인스턴스를 어떤 종류의 오브젝트 위에 배치할 것인지 입니다.
* 폴리지 구체 브러시가 필터 유형에 맞지 않는 오브젝트 위에 있으면 사라지는 것이 보입니다.
* 참고로 활성 스트리밍 레벨에 있는 오브젝트에만 칠할 수 있습니다.
[/EXCERPT:Filter]
--->


[REGION:note]
태블릿 압력 감지 기능도 지원됩니다. 다른 모든 파라미터를 고려한 이후, 펜 압력을 통해 증감되는 폴리지 메시 인스턴스의 수가 변조됩니다.
[/REGION]



## 폴리지 툴
폴리지 창 상단의 툴바에 버튼을 선택하여 사용할 수 있는 툴은 다섯가지 입니다.

| 항목 | 설명 |
| --- | --- |
| ![페인트 툴](ToolPaint.png) | **Paint Tool** (페인트 툴), 월드에/서 폴리지를 더하거나/빼는 데 사용되는 툴입니다. |
| ![재적용 툴](ToolReapply.png) | **Reapply Tool** (재적용 툴), 월드에 이미 칠해진 인스턴스의 파라미터를 변경하는 데 사용됩니다. |
| ![선택 툴](ToolSelect.png) | **Selection Tool** (선택 툴), 이동이나 삭제 등의 작업을 위해 개별 인스턴스를 선택하는 데 사용되는 툴입니다. |
| ![페인트 선택 툴](ToolPaintSelect.png) | **Lasso Tool** (올가미 툴), 페인트 브러시를 사용하여 다수의 인스턴스를 선택하는 데 사용됩니다. |
| ![Fill Tool](ToolFill.png) | **Fill Tool** (채우기 툴), 페인트 툴로 배치하려는 메시의 수를 결정하는 데 사용됩니다. |



### 페인트 툴

![Paint Tool](ToolPaint.png)

페인트 툴은 폴리지 편집 모드의 기본 툴입니다. 레벨의 **메시** 목록에 있는 스태틱 메시 인스턴스를 칠할 수 있습니다.

폴리지 편집 모드가 활성화되면, 레벨에 투명한 구체 브러시가 그려져 폴리지 브러시 적용 위치를 나타냅니다.

**브러시 영역에 폴리지를 칠하려면:**  
* **Ctrl** 키를 누른 상태로 폴리지를 추가하려는 곳에 클릭합니다. 메시 목록에 현재 선택된 메시 전부가 현재 파라미터와 세팅에 따라 추가됩니다.

메시를 칠할 때, 엔진은 구체 내부에서 보는 방향에 평행으로 라인 트레이스를 수차례 실시하여, 구체 내부에 보이는 표면이 폴리지 인스턴스 배치의 잠재적 대상이 될 수 있도록 합니다.

**브러시 영역에서 폴리지를 지우려면:**
* **Ctrl+Shift** 키를 누른 상태로 폴리지를 지우려는 곳에 클릭합니다. 참고로 메시 목록에 현재 선택된 메시 인스턴스만 지워집니다.


#### 페인트 세팅

페인트시 메시 목록의 각 메시에는 그 메시에 대한 인스턴스를 어찌 놓을지를 결정하는 프로퍼티가 여럿 있습니다. 이 프로퍼티는 중간의 페인트 브러시 아이콘을 눌러 열어볼 수 있습니다.

![Paint Settings](Foliage_PaintSettings.png)

| **프로퍼티** | **설명** |
| --- | --- |
| **Density / 1Kuu&sup2;** | 1000uu&sup2; 당 밀도 - 1000x1000 언리얼 유닛 영역마다, 이 메시에 대해 놓을 인스턴스 수입니다. |
| **Radius** | 반경 - 이 메시의 인스턴스 사이에 둘 최소 간격입니다. (2011년 10월 빌드 이후로 정상 작동합니다.) |
| **Align to Normal** | 노멀에 맞춤 - 폴리지 메시의 방향을 수직으로 맞출지, 아니면 놓으려는 표면의 노멀 방향에 맞출지 입니다. |
| **Max Angle** | 최대 각 - 0 이 아니면 노멀에 맞출 때 따를 최대 각을 나타냅니다. 예를 들어 땅의 경사가 30&deg; 이고 Max Angle 을 10&deg; 로 설정했다면, 폴리지가 땅의 방향을 따르긴 하되 수직에서 그 방향으로 10&deg; 까지만 눕습니다. 경사가 5&deg; 인 곳에 인스턴스를 놓는다면, 각이 10&deg; 미만이기에 폴리지는 5&deg; 경사에 맞게 놓입니다. |
| **Random Yaw** | 랜덤 요 - 메시를 Z 축으로 임의 회전시켜 배치할 것인지 입니다. |
| **Uniform Scale** | 균등 스케일 - 인스턴스의 X Y Z 스케일을 독립적으로 조절할 것인가 입니다. |
| **Scale Min/Max** | 최소/최대 스케일 - 인스턴스는 최소 최대 스케일 범위에서 임의로 스케일됩니다. |
| **Random Pitch &plusmn;**| 랜덤 피치 &plusmn; - 지정한 &plusmn; 각도만큼 편차를 두어, 모든 인스턴스가 똑같은 방향을 향하지 않도록 합니다. |
| **Ground Slope** | 땅 경사 - 0 이 아닐 경우, 칠하는 표면의 경사가 이 각도보다 심하면 폴리지 인스턴스를 놓지 않습니다. 음수 값이면 지정된 각보다 경사가 심한 면에만 폴리지 인스턴스를 놓습니다. |
| **Height Min/Max** | 최소/최대 높이 - 지정하면 월드 공간 Z (높이) 값이 이 범위 밖일 경우, 인스턴스가 적용되지 않습니다. |
| **Landscape Layer** | 랜드스케이프 레이어 - 입력하면 랜드스케이프 레이어에 지정된 밀도에다 다른 모든 파라미터를 적용한 값에 비례하여 폴리지 인스턴스를 칠합니다. |



### 재적용 툴

![재적용 툴](ToolReapply.png)

재적용 툴은 월드에 이미 놓인 인스턴스에 대한 파라미터를 선택적으로 변경할 수 있도록 해 주는 툴입니다. 설정 가능한 옵션은 페인트 툴과 매우 유사하나, 왼쪽에 재적용할 파라미터를 선택할 수 있는 체크박스가 추가로 있습니다.

![](Foliage_Reapply.png)(w:400)

체크박스를 설정하면 기존 인스턴스에 브러시를 칠할 때 해당 파라미터가 재적용됩니다. 대부분의 세팅은 페인트 툴을 사용할 때와 비슷하며, 약간의 차이는 있습니다:

| 항목 | 설명 |
| --- | --- |
| **Density Adjust** | 밀도 조정 - 기존 인스턴스에 대한 밀도 배수입니다. 슬라이더를 2.0 으로 설정하면, 지정된 영역 안의 인스턴스 수가 배로 늡니다. 0.5 로 칠하면 인스턴스 수가 절반만 남습니다.|
| **Ground Slope** | 땅 경사 - 땅 경사 조건을 만족하지 않는 인스턴스를 제거합니다. 인스턴스가 새로 추가되지는 않습니다.|
| **Height Min/Max** | 높이 최소/최대 - 높이 범위 조건을 만족하지 않는 인스턴스를 제거합니다. 인스턴스가 새로 추가되지는 않습니다.|
| **Landscape Layer** | 랜드스케이프 레이어 - 지정된 레이어 밀도에 비례해서 인스턴스를 제거합니다. 인스턴스가 새로 추가되지는 않습니다.|


### 선택 툴
![선택 툴](ToolSelect.png)

선택 툴이 활성화되면, 폴리지 메시의 개별 인스턴스를 클릭하여 선택 가능합니다. **Ctrl+클릭** 으로 다중 선택도 가능합니다.

![Selected Instance](Foliage_SelectInstance.png)(w:600)

인스턴스가 선택되었을 때 할 수 있는 동작은 다음과 같습니다:

| **동작** | **결과** |
| --- | --- |
| 위젯 축 끌기 | 선택된 인스턴스는 위젯 모드별로 위젯을 따라 움직이거나 회전되거나 스케일 조절됩니다. |
| Alt + 위젯 축 끌기 | 선택된 인스턴스를 먼저 복제한 다음 위젯을 따라 움직입니다. |
| Delete 키 | 선택된 인스턴스는 삭제됩니다. |
| End 키 | 선택된 인스턴스를 바닥에 끌어붙여 봅니다. 원래 이 세팅이 켜진 상태인 경우 노멀에 정렬됩니다. |



### 올가미 툴

![Lasso Tool](ToolPaintSelect.png)

올가미 툴은 페인트 툴에도 사용되는 구체 브러시를 사용하여 다수의 인스턴스를 동시에 선택할 수 있습니다. 보통의 메시 칠하기를 할 때와 마찬가지로, **메시** 목록 선택과 필터 세팅도 적용됩니다. **Shift** 키를 누른 상태로 칠하면 인스턴스 선택을 해제합니다. 선택을 하고나면, 일반 선택 툴로 전환하여 위와 같은 작업이 가능합니다.

![Lasso Tool](Foliage_Lasso.png)(w:600)

### 채우기 툴

![Fill Tool](ToolFill.png)

채우기 툴은 레벨에 있는 전체 스태틱 메시 액터를 선택된 폴리지 메시로 덮는 데 사용되며, 페인트 세팅에 따라 채우기 밀도와 기타 속성도 적용됩니다.

채우기 툴을 사용하려면, 폴리지로 덮고자 하는 스태틱 메시에 **Ctrl+클릭** 하면 됩니다.

![Foliage Tool](Foliage_Fill.png)(w:600)


## 인스턴스 세팅 모드

인스턴스 세팅 모드를 사용하여 폴리지 툴로 이미 레벨에 배치한 메시 인스턴스를 편집할 수 있습니다.

![Instance Settings Mode](Foliage_Instance.png)(w:500)

| **프로퍼티** | **설명** |
| --- | --- |
| **Instance Count** | 인스턴스 수 - 현재 스트리밍 레벨에 이 메시의 인스턴스가 현재 몇이나 되는가를 나타냅니다. |
| **Cluster Count** | 클러스터 수 - 현재 스트리밍 레벨에서 이 메시의 인스턴스를 렌더링하는 데 사용된 클러스터 수를 나타냅니다. 인스턴스 그룹은 렌더링 효율 향상을 위해 한 번의 드로 콜로 한꺼번에 렌더링되는데, 이를 클러스터라 부릅니다. 클러스터 할당은 클러스터에 있는 인스턴스 수와 월드 스페이스 내 클러스터 반경에 따라 자동으로 결정됩니다. 다음 두 파라미터로 이 기능을 조절할 수 있습니다. |
| **Max Instances Per Cluster** | 클러스터 당 최대 인스턴스 - 클러스터 당 인스턴스 최대 수를 설정합니다. 하나의 클러스터 내 모든 인스턴스는 항상 한 번의 드로 콜로 렌더링되는데, 트라이앵글 총 갯수는 메시 당 폴리곤 수 곱하기 클러스터 당 인스턴스 수 입니다. 이상적인 수치는 메시의 폴리곤 카운트에 따라 다릅니다. |
| **Max Cluster Radius** | 최대 클러스터 반경 - 인스턴스를 새로운 클러스터에 할당하기 전 클러스터가 최대로 늘어날 수 있는 크기입니다. 이 수치를 줄이면 클러스터 갯수는 늘지만 클러스터의 바운딩 박스가 작아지므로 오클루전 효율이 좋아집니다. |
| **Start Cull Distance** | 컬링 시작 거리 - 인스턴스가 사라지기 시작하는 월드 유닛 단위 거리입니다. 머티리얼에서 설정해야 하는 것입니다. 자세한 것은 아래 컬링 부분을 참고하세요. |
| **End Cull Distance** | 컬링 끝 거리 - 인스턴스가 완전히 컬링되는 월드 유닛 단위 거리입니다. 머티리얼에 개별 인스턴스가 사라지도록 구성되지 않은 경우, 전체 클러스터가 한꺼번에 사라졌나 나타났다 합니다. 자세한 것은 아래 "컬링" 섹션을 참고하세요. |



## 컬링

폴리지 인스턴스가 드로 콜 한 번에 클러스터로 렌더링되는 이유로, 각각의 클러스터는 오클루전에 따라 렌더링되거나 말거나 둘 중 하나입니다. **End Cull Distance** (컬링 끝 거리) 파라미터에 값을 설정하면, 그 거리 너머에 있는 클러스터 역시도 컬링됩(가려집)니다. 하지만 이때문에 전체 클러스터가 거리 밖을 벗어남에 따라 급작스럽게 메시 그룹이 사라지게 되기도 합니다.

이러한 현상은 **Start Cull Distance** (컬링 시작 거리) 파라미터를 추가한 다음 머티리얼을 적절히 구성하는 방식으로 줄일 수 있습니다. 버텍스 셰이더에서 인스턴스별 페이드 인수가 계산되는데, 시작 위치에서는 1.0 으로 시작하여 끝 위치에서는 0.0 이 됩니다. 이 값은 머티리얼에서 PerInstanceFadeAmount 노드를 사용하여 접근 가능합니다. 이를 오파시티나 마스킹 값에 연결해 주면, 그 값을 사용하여 컬링 끝 거리 위치에 이르러 렌더링 제외되기 전까지 천천히 사그라들게 만들 수 있는 것입니다.

아래는 머티리얼 마스크에 페이드 인수를 곱해서, 폴리지 메시 나뭇잎이 완전히 사라질 때까지 옅어지게 하는 머티리얼 예제입니다.

![Culling Material Example](Foliage_MaterialSetup.png)


<!-----
![Culling Material Example](CullingMaterial.png)(w:752 h:378)
---->

## 스태틱 메시 세팅

스태틱 메시에 대한 폴리지 관련 옵션은 폴리지 툴이 아닌 **스태틱 메시 에디터** 에서 설정할 수 있습니다.

**스태틱 메시 에디터** 의 **디테일** 패널에서 **Static Mesh Settings** (스태틱 메시 세팅) 섹션에 보면 **Foliage Default Settings** (폴리지 디폴트 세팅) 옵션이 보입니다. 기본적으로 **None** (없음)으로 설정되어 있습니다. 그러나 드롭다운 화살표를 클릭해 보면 **InstancedFoliageSettings** (인스턴싱된 폴리지 세팅)을 선택할 수 있는데, 폴리지 툴을 가지고 이 스태틱 메시를 사용하는 데 적용되는 전체 세팅 하위영역이 열립니다.

![Static Mesh Editor Foliage Settings](Foliage_StaticMeshEditor.png)

### LOD

폴리지에 스태틱 메시 LOD 가 지원됩니다. 주의하실 점이 약간 있습니다:

* 스태틱 메시의 (**LOD0** 아래 보이는) Elements (엘리먼트) 배열에 항목이 딱 하나만 있는지 확인합니다.
* 라이트/섀도우맵이 모든 LOD 레벨에 공유되므로, 모든 LOD 에 같은 unwrapping 을 사용해야 합니다.
* 현재 인스턴스의 클러스터 전부가 LOD 를 동시에 변경합니다. 앞으로 인스턴스별 거리 기반 페이딩을 지원할 수도 있습니다.



### 라이팅

각 개별 메시 인스턴스에는 라이트매스로 자체 생성된 섀도우 그리고/또는 라이트맵이 있어, 이들을 각각의 미리계산된 일괄작업(batch)에 대해 같이 타일링하여 일괄작업(batch)에 미리계산을 지원할 수 있습니다. 폴리지 인스턴스가 제대로 작동하게 하기 위해 미리계산된 라이팅에 대해서 체크해줘야 할 스태틱 메시 세팅이 몇 가지 있습니다. 라이트매스는 인스턴스 메시에 대한 섀도우맵을 생성시 그리 관대하지 못한지라, 세팅이 잘못되면 라이팅 이후 메시가 까맣게 나올 수 있습니다.


* **Light Map Coordinate Index** (라이트맵 좌표 인덱스) - 고유 UV 언래핑을 가진 적합한 UV 채널로 설정해야 합니다. 스태틱 메시 에디터의 **Window** (창) 메뉴에서 접근할 수 있는 **고유 UV 생성** 기능으로 고유 언래핑을 빠르게 생성할 수 있습니다.
* **Lightmap Resolution** (라이트맵 해상도) - (디폴트 크기가 100인) 클러스터 하나에 있는 인스턴스에 대한 모든 섀도우맵이 최대 텍스처 해상도(4096x4096)를 초과하지 않고 타일링 가능하게 하려면, 이 수치가 충분히 작아야 합니다.


[PUBLISH:Licensee]


### 콘솔에서의 인스턴싱 세팅

Xbox360 이나 PS3 같은 콘솔에서의 하드웨어 인스턴싱은 PC 에서와는 약간 다르게 돌아갑니다. 한 번의 드로 콜로 여러 인스턴스를 렌더링하려면, 스태틱 메시에 대한 인덱스 버퍼 데이터를 복사할 필요가 있습니다. 스태틱 메시에 **Console Preallocate Instance Count** (콘솔 미리할당 인스턴스 수)라는 세팅이 있습니다. 이 값을 통해 한 번의 드로 콜로 렌더링시킬 인스턴스를 몇이나 미리 할당시킬지를 조절할 수 있습니다.

예를 들어 트라이앵글이 100 개인 폴리지 메시가 있다면, 보통 버텍스 인덱스는 (트라이앵글당 3 개씩) 300 개가 있어야 일반적인 스태틱 메시로 렌더링할 수 있습니다. 이 버텍스 인덱스 각각은 2 바이트 씩이므로, 그 스태틱 메시에 대해 600 바이트의 데이터가 저장되는 것입니다.

한 번의 드로 콜로 이 메시를 폴리지로 하는 인스턴스를 최대 20 개 까지만 렌더링되도록 하려면, ConsolePreallocateInstanceCount 를 20 으로 설정, 그 300 인덱스 값을 20 번 복사하여 저장합니다. 즉 스태틱 메시의 인덱스에 필요한 메모리 총량이 12,000 (20 x 300 x 2) 바이트로 늘어난다는 뜻입니다.

레벨에 인스턴스가 몇이나 놓여있든 관계없이 이러한 부하는 스태틱 메시에 대해서 한 번만 발생합니다. 그러나 이 데이터를 미리 할당해 둔 것만으로도 언제든 한 번의 드로 콜로 이 스태틱 메시의 인스턴스를 20 개 까지, 즉 2000 트라이앵글을 렌더링할 수 있는 것입니다.

(위의 Instances Per Cluster 세팅에 따라) 한 클러스터에서 렌더링하려는 인스턴스 수에 비해 ConsolePreallocateInstanceCount 수가 충분치 않을 경우, 엔진은 자동으로 복수의 드로 콜을 내립니다.

콘솔에서 드로 콜 비용은, 그 드로 콜에 렌더링되는 트라이앵글 수가 충분히 크기만 하다면야, 상대적으로 비싸지 않습니다. 즉 한 번의 드로 콜에 더 많은 인스턴스를 미리 할당하기 위해 메모리를 쓴다고 성능이 크게 향상되지는 않을 것입니다.

즉 폴리지에 사용되는 스태틱 메시에 대한 ConsolePreallocateInstanceCount 수치는, 한 인스턴스의 트라이앵글 수를 고려해서, 콘솔의 GPU 를 놀리지 않을 수 있을 만한 수치로 설정해야 합니다. 너무 작게 설정하면 개별 드로 콜을 기다리느라 콘솔의 GPU 가 빈둥거리게 될 수 있으며, 너무 크면 별다른 성능 향상도 없이 메모리만 낭비됩니다.
[/PUBLISH:Licensee]

 




