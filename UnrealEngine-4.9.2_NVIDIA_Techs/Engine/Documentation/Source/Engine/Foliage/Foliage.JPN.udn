INTSourceChangelist:2516153
Availability:Public
Title:フォリッジ インスタンス化メッシュ
Crumbs:%ROOT%, Engine
Description:フォリッジまたは他のグラウンド カバー エフェクトとして使用するために、他のジオメトリのサーフェスでインスタンス化されたメッシュをレンダリングするシステム

[VAR:Topic]
[OBJECT:Topic]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[VAR:TopicCompact]
[OBJECT:TopicCompact]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[REGION:header_img]
![Foliage Tool](Foliage_Banner.png)(w:900)
[/REGION]

[TOC(start:2 end:2)]

## 概要

[EXCERPT:Intro]

この新たな フォリッジ システムによって、レガシー テレインおよびスタティック メッシュ、ランドスケープ上のメッシュ群をすばやくペイントまたは消去することができるようになります。これらのメッシュは、ハードウェア インスタンシングを使用してレンダリングされるバッチに自動的に統合されます。つまり、たった 1 度のドローコールで多数のインスタンスをレンダリングすることができるということです。

[/EXCERPT:Intro]

フォリッジ ツールの実施例を見るには、 [](Resources\ContentExamples\Landscapes) の [フォリッジ](Resources\ContentExamples\Landscapes\1_3) にあるコンテンツ例をご覧ください。

##フォリッジ編集モード

フォリッジ ツールを使用するには、アンリアル エディタの左上隅にある **[Modes]** パネルの [Foliage] ボタンをクリックします。 

![FoliageMode.png](FoliageMode.png)
 
**[Modes]** パネルに [Foliage Edit Mode] ウィンドウが表示されます。

![FoliageWindowInitial.png](FoliageWindowInitial.png)



## メッシュ リスト

最初は、フォリッジ メッシュが何もリストされていません。フォリッジをペイントする前に、コンテンツ ブラウザからスタティック メッシュを **[Drag Static Meshes from the Content Browser into this area (スタティックメッシュをコンテンツブラウザからこの領域にドラッグする)]** と書かれている黒いバーに直接ドラッグしなければなりません。

![](Foliage_TextBar.png)

[REGION:tip]
最初のスタティック メッシュを黒いバーの下の空のスペースではなく、黒いバーの上にドロップするようにしてください。
[/REGION]

[REGION:note]
最初のスタティック メッシュがリストに追加された後、スタティック メッシュを [Foliage Edit Mode] ウィンドウへドラッグし、リスト内の既存メッシュの一番上にドロップすることにより、もっと多くのメッシュを追加することができます。
[/REGION]

<!----
![FoliageWindowDrag.png](FoliageWindowDrag.png)
---->

メッシュ リストのスタティック メッシュは、3 つのモードのいずれかで表示されます:
* **[Hide Details]** - 全てのパラメータとプロパティを非表示にして、リスト全体を見やすくします。

	![FoliageWindowAfterDrag.png](FoliageWindowAfterDrag.png)
* **[Show Painting Settings]** - レベル内のメッシュ配置に対しパラメータがどう影響するかを表示します。(スタティック メッシュが追加されると、このモードがデフォルトになります。)

	![Moliage Painting Settings](Foliage_MeshParams.png)
* **[Show Instance Settings]** - レベル内に既に配置されているインスタンスを制御するパラメータを表示します。

	![Mesh Instance Settings](Foliage_ShowInstance.png)

メッシュが **Paint Settings** あるいは **Instance Settings** モードの場合、3 つのボタンはメッシュ アイコン上にも表示されます。

| アイテム | 説明 |
| --- | --- |
| ![](Shared/Icons/icon_assign_left_16x.png) | 現在のレベルにすでに配置されているメッシュの全インスタンスを、 **コンテンツブラウザ** で現在選択されているスタティック メッシュと交換します。 |
| ![](Shared/Icons/icon_delete.png)(w:16) | メッシュ リストからメッシュだけでなく、 **現在のレベルに既に配置されているこのメッシュの全インスタンス** も削除します。 |
| ![](Shared/Icons/icon_MeshPaint_Find_16x.png) | コンテンツ ブラウザにおいてスタティック メッシュの位置を示します。 |

###メッシュ リストで選択されたメッシュ

メッシュは **メッシュ** リストでクリックすると選択 / 選択解除することができます (オレンジが選択中)。レベル エディタのビューポートでメッシュの作成 / 削除を行うと、 **メッシュ** リスト内で選択中のメッシュのみが影響を受けます。レベルに既にある他のスタティック メッシュのフォリッジのインスタンスは全く影響を受けません。また選択解除された **メッシュ** リスト アイテムのインスタンスが、レベルに追加されることもありません。

次は、 2 個のメッシュが選択されている例です。**SM_Rock** メッシュは選択されていないので、ペイントやレベルからの消去は行われません。

![Two Meshes Selected](Foliage_MeshList.png)

####ブラシの設定

**メッシュ** リストの上に、 メッシュ編集ツールが現在選択中のフォリッジ ツールに関連するプロパティを表示します。(全ての設定にそれぞれフォリッジ ツールが付いているわけではありません。)

| アイテム | 説明 |
| ---- | ----------- |
| **Brush Size** | ブラシのサイズは、アンリアル単位によるブラシのサイズです。  | 
| **Paint Density** |  [INCLUDE:Engine/Foliage#PaintDensity] |
| **Erase Density** |  [INCLUDE:Engine/Foliage#EraseDensity] |
| **Filter** | [INCLUDE:Engine/Foliage#Filter] |

<!---
[EXCERPT:PaintDensity]
**Ctrl + クリック** を使用しながらインスタンスを追加する際の、目標密度です。
* この範囲は、 0 から 1 までです。値が 1 の場合は、各メッシュの Mesh プロパティ (下記参照) にある最大密度でメッシュ インスタンスをペイントします。
* ブラシ内にあるメッシュの密度がすでにこの値を超えている場合は、メッシュがまったく追加されません。
[/EXCERPT:PaintDensity]
--->


<!---
[EXCERPT:EraseDensity]
**Ctrl+Shift+ クリック** を使いながらインスタンスを消去する場合に狙うターゲット密度です。
* この値の範囲は 0 から 1 までです。値が 0 の場合は、メッシュがまったく表現されません。この目標となる消去密度よりもメッシュが少ない場合は、メッシュがそれ以上消去されることはありません。 
* この設定項目によって、すべてのインスタンスを完全に除去することなく、すでにペイントされているメッシュを間引くことができます。
[/EXCERPT:EraseDensity]
--->

<!---
[EXCERPT:Filter]
どのような種類のオブジェクト上にインスタンスを配置するか制御できます。 
* フィルタタイプに適合しないオブジェクト上では、フォリッジ球体ブラシが消えるため、ご注意ください。 
* また、アクティブなストリーミング レベルのオブジェクト上でしかペイントできませんので、ご注意ください。
[/EXCERPT:Filter]
--->


[REGION:note]
また、タブレットの圧力感受性がサポートされています。ペンの圧力によって、追加 / 削除されるフォリッジ メッシュ インスタンスの数を制御することができます (これは、他のパラメータがすべて考慮された上で実行されます)。
[/REGION]



## Foliage ツール
[Foliage] ウインドウ最上部のツールバーから適切なボタンを選択すると、 5 つのツールを使用することができます。  

| アイテム | 説明 |
| --- | --- |
| ![Paint Tool](ToolPaint.png) | **Paint ツール** は、フォリッジ インスタンスをワールドに追加したり、ワールドから削除するために使います。 |
| ![Reapply Tool](ToolReapply.png) | **Reapply ツール** は、既にワールドにペイントされたインスタンスのパラメータの変更に使用します。 |
| ![Select Tool](ToolSelect.png) | **Selection ツール** は、移動、削除などのために個々のインスタンスを選択するために使用します。 |
| ![Paint Select Tool](ToolPaintSelect.png) | **Lasso ツール** は、ペイントブラシを使って多数のインスタンスを選択するためのツールです。 |
| ![Fill Tool](ToolFill.png) | **Fill ツール** は、Paint ツールを使って配置するメッシュ数を決定するためのツールです。 |



### Paint ツール

![Paint Tool](ToolPaint.png)

Paint ツールは フォリッジ編集モードのデフォルトのツールです。レベル内の **メッシュ** リストのスタティック メッシュのインスタンスをペイントするためのツールです。

フォリッジ編集モードがアクティブな場合、透明な球体ブラシがレベル内で描画され、フォリッジ ブラシが機能する場所を示します。

**フォリッジをブラシの領域に追加する方法**  
* **[Ctrl]** を押して、フォリッジを追加したい場所をクリックします。メッシュ リストで現在選択されている全てのメッシュが、それぞれの現在のパラメータと設定に合わせて追加されます。

メッシュをペイントする場合、エンジンは、視線に平行に多数のライントレースを球体内部で実行します。つまり、球体内部に見えるサーフェスはどこもフォリッジ インスタンスの潜在的なターゲットになり得るということになります。

**ブラシの領域からフォリッジを消去する方法**  
* **Ctrl+Shift** を押して、削除したいフォリッジの場所をクリックします。メッシュ リスト内で現在選択中のメッシュのインスタンスのみが削除されることにご注意ください。


#### ペイントの設定項目

メッシュ リスト内にある各メッシュにはプロパティが多数あり、ペイント時に、当該メッシュのためにインスタンスをどのように配置するかを制御することができます。プロパティにアクセスするには、中央のペイントブラシのアイコンをクリックします。

![Paint Settings](Foliage_PaintSettings.png)

| **プロパティ** | **説明** |
| --- | --- |
| **Density (密度) / 1Kuu&sup2;** | 1000x1000 アンリアル単位の面積につき配置されるインスタンス数です。 |
| **Radius (半径) ** | メッシュのインスタンス間の最短距離です。  |
| **Align to Normal (法線に合わせる) ** | フォリッジ メッシュを垂直の方向に向けるか、あるいは、フォリッジ メッシュが配置されるサーフェスの方向に従うかを決めます。 |
| **Max Angle (最大角度)** | ゼロ以外の場合、法線に合わせる場合に従うべき最大角度を指定します。たとえば、グラウンドが 30 度のスロープになっていて、 Max Angle を 10 度にセットした場合、フォリッジは、グラウンドの方向に従おうとしますが、垂直線に対して 10 度の角度で置かれます。インスタンスを 5 度のサーフェスに配置すると、その角度が 10 度よりも小さいため、フォリッジは 5 度のスロープに合うように方向づけられます。
| **Random Yaw** |  メッシュを Z 軸のまわりにランダムに回転して配置するかを決めます。 |
| **Uniform Scale (一様なスケーリング)** | インスタンスの X および Y、Z のスケールを個別にスケーリングするか否かを決めます。 |
| **Scale Min/Max (スケール最小 / 最大)** | スケールの最小 / 最大範囲からランダムに選択してインスタンスをスケーリングします。 |
| **Random Pitch (ランダムピッチ) &plusmn;** | 角度を指定し、最大でその角度 ± の変化を加えます。これによって、インスタンスのすべてが同一の方向に向かないようにすることができます。 |
| **Ground Slope (グラウンドスロープ)** | ゼロ以外の場合、ペイントする際に下にあるサーフェスがこの角度よりも急であるならば、フォリッジ インスタンスが配置されません。値がマイナスの場合は、指定角度よりも急なサーフェス上でのみフォリッジ インスタンスが配置されます。 |
| **Height Min/Max (高さ 最小 / 最大)** | これが指定されると、ワールド空間の Z (高さ) 値がこの範囲から外れる場合に、インスタンスが適用されなくなります。 |
| **Landscape Layer (ランドスケープ レイヤー)** | これが入力されていると、他のすべてのパラメータが適用された上で、フォリッジインスタンスが指定されたランドスケープ レイヤーの密度に応じてペイントされます。 |



### Reapply ツール

![Reapply Tool](ToolReapply.png)

ワールド内に配置済みのインスタンスのパラメータを選んで変更することができるツールです。使用できる設定項目は、Paint ツールとよく似ていますが、左側にチェックボックスが追加されています。これは、再適用するパラメータを選択するためのものです。

![](Foliage_Reapply.png)(w:400)

チェックボックスにチェックを入れると、既存のインスタンスの上をブラシでペイントしながら、そのチェックボックスに対応するパラメータを再適用することができます。ほとんどの設定項目は、Paint ツールの場合と同様に使用できますが、相違点もいくつかあります。

| アイテム | 説明 |
| --- | --- |
| **Density Adjust (密度調整)** | 既存のインスタンスのための密度乗数です。スライダーを 2.0 にセットすると、特定のエリアにあるインスタンスの数が 2 倍になります。値を 0.5 にすると、インスタンスのうちの 50% しかペイント後に残らないことになります。|
| **Ground Slope** | グラウンドのスロープ基準に適合しないインスタンスを削除します。新たなインスタンスは追加されません。 |
| **Ground Slope** | 高度範囲基準に適合しないインスタンスを削除します。新たなインスタンスは追加されません。 |
| **Landscape Layer** | 指定されたレイヤー密度に適合しないインスタンスを削除します。新たなインスタンスは追加されません。 |


### Select ツール
![Select Tool](ToolSelect.png)

Select ツールが有効になっている場合は、個々のインスタンスをクリックすることによって選択が可能になります。**Control + クリック** で複数の選択が可能です。

![Selected Instance](Foliage_SelectInstance.png)(w:600)

インスタンスの選択が完了すると、豊富なアクションを使用することができます。

| **動作** | **結果** |
| --- | --- |
| **ウィジェットの軸をドラッグする** | 選択されているインスタンスが、ウィジェットのモードに応じて、ウィジェットに従って動いたり、回転したり、スケーリングしたりします。 |
| **Alt キーを押下しながらウィジェットの軸をドラッグする** | 選択されているインスタンスがまず複製され、さらに、ウィジェットに従って動きます。 |
| **Dlete キー** | 選択されているインスタンスが削除されます。 |
| **End キー** | 選択されているインスタンスが、フロアにスナップしようとします。元々この設定項目が有効な状態で配置されている場合は、インスタンスが法線に平行になります。



### Lasso ツール

![Lasso Tool](ToolPaintSelect.png)

Paint ツールでも使用する、球体ブラシで多数のインスタンスを同時に選択できるツールです。通常のメッシュ ペイントの場合と同様に、 **Meshes** リスト選択とフィルタ設定が適用されます。**Shift** を押しながらペイントすると、インスタンス選択が解除されます。選択が完了すると、通常の選択ツールに切り替えて、上記に掲載されている動作を実行することができます。

![Lasso Tool](Foliage_Lasso.png)(w:600)

### Fill ツール

![Fill Tool](ToolFill.png)

選択したフォリッジ メッシュや Fill ツール、ペイント設定項目に合わせたその他のプロパティで、レベル内のスタティック メッシュ アクタ全体をカバーするために使用するツールです。

Fill ツールを使用するには、フォリッジでカバーしたいスタティック メッシュ上で **Ctrl + クリック** します。

![Foliage Tool](Foliage_Fill.png)(w:600)


## Instance Settings モード

Instance Settings モードを使って、フォリッジ ツールでレベル内に既に配置したメッシュ インスタンスを修正できます。

![Instance Settings Mode](Foliage_Instance.png)(w:500)

| **プロパティ** | **説明** |
| --- | --- |
| **Instance Count (インスタンス数)** | 現在のストリーミングレベル内に現在配置されている当該メッシュのインスタンス数を示します。 |
| **Cluster Count (クラスター数)** | 現在のストリーミングレベル内にある当該メッシュのインスタンスをレンダリングするために使用するクラスターの個数を示します。インスタンスのグループが単一のドローコール (クラスター) でレンダリングされることによって、レンダリングの効率が向上します。クラスターへの割り当ては、自動的に決まります。クラスター内にすでに存在するインスタンスの個数、および、ワールド空間内にあるクラスタの半径に基づいて決まります。次の 2 つのパラメータによって調節することができます。 |
| **Max Instances Per Cluster (クラスター毎のインスタンス)** | クラスター毎に含まれるインスタンスの最大数を設定します。なお、単一のクラスター内にあるすべてのインスタンスは、単一のドローコールでレンダリングされ、トライアングルの総数は、クラスター毎のインスタンスによって乗じられたメッシュ毎のポリゴン数と等しくなります。理想の個数は、メッシュのポリゴン数に依存します。 |
| **Max Cluster Radius (クラスター半径)** | クラスターの最大サイズです。これを超えると、インスタンスが新たなクラスターに割り当てられます。この数値を減らすと、クラスの数が増えます。ただし、クラスターのバウンディングボックスが小さくなるため、オクルージョンが向上します。 |
| **Start Cull Distance (カリング距離始点)** | インスタンスがフェードアウトし始める距離です (ワールド単位)。なお、これはマテリアルで設定する必要があります。以下のカリングのセクションを参照してください。 |
| **End Cull Distance (カリング距離終点)** | インスタンスが完全にカリングされる距離です (ワールド単位)。個々のインスタンスがフェードされるようにマテリアルが設定されていない場合は、クラスター全体が一遍に消滅したり再表示されたりします。以下のカリングのセクションを参照してください。 |



##カリング

フォリッジ インスタンスがクラスターとして単一のドローコールでレンダリングされるため、各クラスターは、オクルージョンに基づいてレンダリングの可否が決定されます。**End Cull Distance** パラメータに値が設定されていると、この距離を超えてもクラスターがカリングされます。ただし、クラスター全体が範囲外になると、メッシュのグループが突然消滅してしまうことになります。

この現象を緩和するには、 **Start Cull Distance** パラメータを追加し、マテリアルを適切に設定します。頂点シェーダーにおいて、インスタンス毎の係数が計算されます。係数は、距離の始点で 1.0 から始まり、終点で 0.0 となります。PerInstanceFadeAmount ノードを使用することでマテリアル内でアクセスできます。この係数をオパシティまたはマスクの値と接続することによって、インスタンスが **Cull Distance End** に達する前にフェードアウトさせ、レンダリングから除外できます。

次のサンプルマテリアルでは、フェード係数によってマテリアルのマスクが乗じられています。その結果、フォリッジ メッシュの葉が、完全に消えるまで間引かれていきます。

![Culling Material Example](Foliage_MaterialSetup.png)


<!-----
![Culling Material Example](CullingMaterial.png)(w:752 h:378)
---->

## スタティック メッシュの設定

スタティック メッシュに対するフォリッジ関連オプションの設定を、フォリッジ ツールではなく **スタティック メッシュ エディタ** に設定できます。

**スタティック メッシュ エディタ** 、 **[Details]** パネル、 **[Static Mesh Settings]** セクションには、 **[Foliage Default Settings]** オプションがあります。デフォルトでは **None** に設定されています。ドロップダウンの矢印をクリックすれば、 **InstancedFoliageSettings** を選択でき、Foliage ツールでスタティック メッシュの使用を適用できる設定のサブ領域を開くことができます。これらの設定は、Foliage ツールの **Show Painting Settings** と **Show Instance Settings** の設定をミラーします。

![Static Mesh Editor Foliage Settings](Foliage_StaticMeshEditor.png)

###LOD

スタティック メッシュの LOD はフォリッジでサポートされています。以下は注意事項です。

* スタティック メッシュは Elements 配列への入力が 1 つだけになっていることを確認してください (**LOD0** で表示可能)。
* すべての LOD レベル間で光源とシャドウマップが共有されているため、全 LOD で同一のアンラッピングが使用される必要があります。
* 現在のところ、インスタンスの全クラスタが、 LOD を同時に変更します。将来、インスタンスごとに距離ベースのフェーディングをサポートする可能性があります。



### ライティング

各メッシュインスタンスは、それ自身のシャドウまたはライトマップ (またはその両方) が Lightmass によって生成されます。これらは、事前計算された各バッチについて、ともにタイル処理されます。事前計算された光源処理がインスタンス化されたフォリッジについて適切に機能するためには、スタティックメッシュ上でいくつかの設定項目をチェックしなければなりません。インスタンス化されたメッシュのためにシャドウマップを生成する場合、 Lightmass はより厳格です。不適切な設定を行うと、光源処理を再ビルドした後にメッシュが黒くなる場合があります。


* **Light Map Coordinate Index (ライトマップ座標インデックス)** - ユニークな UV ラッピングを有する有効な UV チャンネルにセットされなければなりません。スタティック メッシュ エディタの **一意のUV を生成** は、 **[Window]** メニューから使用することができ、ユニークなラッピングをすばやく作成することができる機能です。
* **Lightmap Resolution** - この値を充分に小さくすることによって、 (デフォルトでは 100 である) 単一のクラスター内にあるインスタンスのための全シャドウマップが、最大テクスチャ解像度 (4094x4096) を超えることなくタイル処理されるようにしなければなりません。


[PUBLISH:Licensee]


### コンソール上でのインスタンス設定

Xbox360 や PS3 といったコンソール上でのハードウェア インスタンス化は、 PC の場合と少し異なる動作をします。 1 回のドローコールで複数のインスタンスをレンダリングするには、スタティック メッシュのインデックス バッファ データを複製する必要があります。スタティック メッシュには、 **Console Preallocate Instance Count (コンソール事前割り当てインスタンス数)** という設定項目があります。この値を使って、 1 度のドローコールでレンダリングされるべきインスタンスの事前割り当て数を設定することができます。

たとえば、 100 個のトライアングルをもつフォリッジメッシュがある場合、通常のスタティック メッシュとしてレンダリングすべき頂点インデックスは、 300 個となるのが普通です (トライアングル 1 個につき 3 個の頂点インデックス)。 頂点インデックス 1 個につき 2 バイトであるため、 600 バイトのデータがスタティック メッシュのために格納されていることになります。 

フォリッジとして、このメッシュのインスタンスを 1 回のドローコールで最大 20 個までレンダリングできるようにする場合は、 ConsolePreallocateInstanceCount を 20 にセットします。これによって、 300 個のインデックスの 20 倍の複製値が格納されます。すなわち、このスタティック メッシュのインデックスに必要な合計メモリは、 12,000 バイト (20 X 300 X 2) まで増えることになります。

レベル内に配置されるインスタンスの数にかかわりなく、このスタティック メッシュのためのオーバーヘッドは 1 度しか生じません。データを事前割り当てするだけで、スタティック メッシュの最大 20 個のインスタンス (2,000 個のトライアングル) を 1 度のドローコールで望む時にレンダリングすることができるようになります。 

ConsolePreallocateInstanceCount が、クラスタ内でレンダリングする必要があるインスタンスの数 (前述の Instances Per Cluster 設定値) に不十分な場合は、エンジンが自動的に複数のドローコールを発行します。 

コンソールでは、 1 回のドローコールでレンダリングされるトライアングルの総数がかなり多いため、ドローコールのコストは相対的に低くなっています。そのため、メモリを使用して 1 回のドローコールでより多くのインスタンスを事前割り当てしても、著しいパフォーマンスの向上が見られないことになります。

したがって、フォリッジに使用されるスタティック メッシュのための ConsolePreallocateInstanceCount 数には、(インスタンス内のトライアングル数を考慮に入れて) コンソールの GPU をビジーにする数をセットすべきです。小さすぎる数をセットすると、コンソールの GPU が個々のドローコールを待ってアイドリングの状態となります。また、大きすぎる数をセットすると、パフォーマンスはさほど向上しないままメモリだけが浪費されてしまいます。
[/PUBLISH:Licensee]

 




