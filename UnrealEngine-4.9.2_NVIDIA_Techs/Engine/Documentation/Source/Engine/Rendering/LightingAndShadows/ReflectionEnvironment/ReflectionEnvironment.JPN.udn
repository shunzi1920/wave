INTSourceChangelist:2523071
Availability:Public
Title:反射背景
Crumbs: %ROOT%, Engine, Engine/Rendering/LightingAndShadows
Description:ローカルの光沢がある質感の光の反射をキャプチャ及び表示するシステム

[VAR:Topic]
[OBJECT:Topic]
	[PARAM:image]
		![%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:title%](%ROOT%/Engine/Rendering/LightingAndShadows/ReflectionEnvironment/reflection_topic.png)
	[/PARAM]
	[PARAM:icon]
	![](%ROOT%/ue4_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
	%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:title%
	[/PARAM]
	[PARAM:description]
	%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Rendering/LightingAndShadows/ReflectionEnvironment]
	[/PARAM]
[/OBJECT]
[/VAR]
[VAR:TopicCompact]
[OBJECT:TopicCompact]
	[PARAM:image]
		![%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:title%](%ROOT%/Engine/Rendering/LightingAndShadows/ReflectionEnvironment/reflection_topic.png)
	[/PARAM]
	[PARAM:icon]
	![](%ROOT%/ue4_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
	%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:title%
	[/PARAM]
	[PARAM:description]
	%Engine/Rendering/LightingAndShadows/ReflectionEnvironment:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Rendering/LightingAndShadows/ReflectionEnvironment]
	[/PARAM]
[/OBJECT]
[/VAR]

[EXCERPT:ReflectionEnv001]
**反射背景** 機能は、シーンのあらゆる領域で効果的な光沢のある反射を作成します。メタルなど 
重要なマテリアルの多くは、反射背景がもたらす全方向へ光を反射させる 
効果に依存しています。コンソールとの中間スペック PC を対象としているため、実行が高速でなくてはいけません。動的オブジェクトの反射やシャープな反射は利用出来ません。 
このような反射は、Screen Space Reflections（スクリーン空間反射）など、反射背景を他の反射技術で補って 
完成させなくてはいけません。
[/EXCERPT:ReflectionEnv001]

[REGION:fullwidth]
![Reflection Environment](reflection_environment.png)
[/REGION]

## 簡易設定

反射背景を使用するために、まずライティングを設定して一度ライティングのビルドを行います。 **この時に反射背景を表示するために、 
間接的なディフューズライティングがなくてはいけません。** 次に **Modes** パネルの _Place Mode_ にある _Visual_ タブから 
 *_SphereReflectionCapture_* アクタをレベルへドラッグして、マテリアルに目立つスペキュラと低度の粗さが生じていることを確認します。  
キャプチャした画像を可視化するために [Reflection Override] ビューモードを使用します。

## 光沢のある間接スペキュラ

技術的な言葉で言えば、反射背景は間接スペキュラを作成します。直接スペキュラは解析ライトを通じて受け取りますが、 
いくつかの明るい方向へ反射を作成するのみです。スペキュラは、スカイライトを通じて空からも受け取りますが、 
スカイライト キューブマップは限りなく距離が遠いため、ローカル反射は作成しません。間接スペキュラは、シーンのあらゆる部分を別の領域へ反射させます。 
ディフューズへの応答機能を持たないメタルなどのマテリアルには、特に重要な機能です。

[REGION:imagetable]
| ![Diffuse Only](DiffuseOnly.png)(w:465) | ![Reflection Only](ReflectionOnly.png)(w:465) |
| ------ | ------ |
| ディフューズのみ | 反射のみ |
[/REGION]

**フルライティング**

[REGION:fullwidth]
![Full Scene](Complete.png)
[/REGION]

[EXCERPT:RefEnvIntro]
反射環境はたくさんの点で静的シーンをキャプチャし、球など 
シンプルな形状へキャプチャを再投影します。アーティストは、**_ReflectionCapture_** アクタを配置して 
キャプチャする点を選択します。反射は配置調整のため、編集中はリアルタイムで更新されますが、実行時は静的です。 
キャプチャしたシーンをシンプルな形状に投影すると、反射のおおよその視差がわかります。各ピクセルは 
複数のキューブマップをブレンドして最終結果を表示します。小さいほうの ReflectionCapture アクタが大きいアクタをオーバーライドするので、必要に応じて領域内の反射の視差精度の微調整が可能になります。例えば、 
部屋の真ん中にキャプチャを配置した後に、部屋の隅に小さなキャプチャを配置することによって 
反射を微調整します。 
[/EXCERPT:RefEnvIntro]

さまざまな光沢をもつマテリアルは、キャプチャーしたキューブマップからブラーがかったミップマップを生成することによってサポートされています。
  
![Varying Glossiness](VaryingGlossiness.png)

しかし非常にラフなサーフェスへキューブマップ反射を使用すると、 
ローカルオクルージョン欠如のため多大な漏れ光が生じた過度に明るい反射となってしまいます。ライトマスで生成される 
ライトマップデータを再利用してこの問題を解決することができます。マテリアルの粗さに基づいて、キューブマップ反射効果を 
ライトマップの間接スペキュラと混ぜ合わせます。とても粗いマテリアル（完全にディフューズ）は、ライトマップの結果に収束します。 
効果の混ぜ合わせは、本質的にライティングデータ（キューブマップ）一式の極めて詳細な部分と、 
別のライティングデータ（ライトマップ）一式の低頻度部分を結合したものです。これを正しく機能させるには、 
間接ライティングのみをライトマップに含みます。これは固定ライトからの間接ライトのみが粗いサーフェスの 
反射品質を向上することができるからです。 **静的ライトのタイプは、ライトマップに直接光を投じるため、 Reflection Enviornment と一緒に使用してはいけません。** 。 
ライトマップと混ぜ合わせるということは、 
マップは重要な間接ディフューズライティングを持つこと、また結果を確認するためにライティングが既にビルドされていなくてはいけない 
ことに注目してください。

[REGION:imagetable]
| ![Rough with no Shadowing](2RoughWithNoShadowing.png)(w:465) | ![Rough with Shadowing](2RoughWithShadowing.png)(w:465) |
| ------ | ------ |
| シャドーイングなしの粗いサーフェス上の反射 | ライトマップからのシャドーイングと SSAO を統合 |
[/REGION]

## 反射のキャプチャ形状

[EXCERPT:RefCaptures]
現時点では、球とボックスの2つの反射キャプチャ形状が有効です。キャプチャ形状は、 
キューブマップへキャプチャするシーンの一部、反射でシーンを再投影する形状、 
またキューブマップ（影響範囲）から反射を受け取ることができるシーンの一部を制御するため大変重要です。
[/EXCERPT:RefCaptures]

###球の形状

現時点で球は一番便利な形状です。反射しているジオメトリ形状と決して合致することはありませんが、 
形状に切れ目や隅がないため、同じようなエラーが生じます。 

![Sphere Shape](SphereShape.png)(w:720)

球体形状には、キューブマップから影響を受けるピクセルと 
シーンが再投影される球をコントロールするオレンジ色の影響半径があります。 

小さいほうのキャプチャが大きい方のキャプチャをオーバーライドするので、シーン周りに小さなキャプチャを配置することで微調整が出来ます。

### ボックスの形状

ボックス形状は有用性に限りがあり、通常は廊下や四角い部屋の用途のみに機能します。理由は、 
ボックス内のピクセルのみが反射を理解すると同時に、ボックス内の全てのジオメトリはボックス形状に投影されるため、 
ほとんどの場合において著しいアーティファクトを発生させるためです。

![Box Shape](BoxShape.png)

選択時は、投影形状のオレンジのプレビューがボックスに表示されます。ボックスの外側の **Box Transition Distance** 内にある 
シーンのみをキャプチャします。ボックス内のキャプチャの影響は、移動距離によっても 
フェードインします。 

## 編集

反射キャプチャは自動的に最新の状態に保たれないことに注意してください。反射キャプチャは、マップの読み込み、 
キャプチャまたはビルドしたライティングの直接編集のみを更新します。ライトの輝度の変更や 
シーンジオメトリの移動など別の編集をする場合、変更を伝播するために 
キャプチャを選択して「'Update Captures'」をクリックする必要があります。 

### 視覚化

反射の設定の参照を簡単にするために [Reflection Override] ビューモードが追加されました。 
このビューモードは全ての法線をスムーズな頂点法線へとオーバーライドして、 
全サーフェスを完全なスペキュラ（鏡面反射）および全体的に滑らかにします（鏡のような効果）。このモードは反射背景の制限事項やアーティファクトも顕著に浮き彫りにするため、 
通常の状態 (凸凹な法線、さまざまな光沢、薄暗いスペキュラ) で反射の見え方を確認するために 
定期的にLit（ライティング有）へ切り替えることが重要となります。

![Reflection Override](ReflectionOverride.png)

ライティングのコンポーネントを分離させるのに便利な表示フラグが新規に追加されました。

| フラグ | 説明 |
| ---- | ----------- |
| **Lighting Components > Diffuse** | ディフューズを無効にすると、すべてのライティング手法でディフューズ効果を非表示にします。 |
| **Lighting Components > Specular** | スペキュラを無効にすると、すべての反射手法でスペキュラ効果を非表示にします。 |
| **Lighting Features > ReflectionEnvironment** | 反射背景機能を無効にしますが、その他の反射機能はアクティブなままです (SSR、解析的スペキュラ)。 |


## 反射背景を使用するためのレベル設定

1. リアルな反射を作成する第一段階は、ライトマップを経由する間接光を含めた 
ディフューズライティングの設定です。ライトマスのページには詳細情報が記載されています。ビルド後、ライトマスの間接光の妨げとなる良くあるエラーに、シャドウキャスティングスカイボックス、 
 **_LightmassImportanceVolume_** の欠如、ライトマスUVの非設定または誤設定、 
もしくは **World Properties** に **Force No Precomputed Lighting** を設定していることが挙げられます。

	シーンのディフューズは、反射背景経由の反射結果となります。最良の結果とするため、 
	直接Lit（ライティング有）されている領域とシャドウがかかった領域間の顕著なコントラストの違いを確認してください。明るい 
	ディフューズでLitされた領域は、はっきりと反射に表示されます。暗いシャドウが適用された部分は、 
	反射が最も明白な領域です。反射キャプチャとしてシーンを表示するために、 
	 [Lit] ビューモードと表示フラグを無効にしたスペキュラを一緒に使用します。

1. 反射背景とうまく機能させるために、シーンのマテリアルを設定することは大変重要です。 
平面および鏡面サーフェスは、シンプルな形状に投影された結合キューブマップの誤差を露呈します。 
しかし曲線ジオメトリやラフなサーフェスではアーティファクトが不明瞭なため、納得のいく結果となってしまいます。　 
よって、詳細な法線マップの使用と、平面な領域に使用するマテリアルのラフネスの度合いの指定が 
重要となります。

	[REGION:imagetable]
	| ![Curvy and Sharp](1CurvyAndSharp.png)(w:290) | ![Flat and Rough](1FlatAndRough.png)(w:290) | ![Flat and Sharp](1FlatAndSharp.png)(w:290) |
	| ------ | ------ | ------ |
	| 滑らかな表面＋曲線ジオメトリ:高品質な反射 | 粗いサーフェス＋平面ジオメトリ:高品質な反射 |滑らかな表面＋平面ジオメトリ:上手く調和しない反射が明確
	[/REGION]

1. 反射させたい領域に反射キャプチャを配置します。シーンは球形状へ再投影されるため、 
反射させたいレベルの一部が半径のちょうど内側へ含まれるように 
球キャプチャを配置します。隣接するジオメトリは後方に位置する重要な詳細より優先され妨害となるため、 
キャプチャがシーンジオメトリに近すぎないように配置してください。

## パフォーマンスの検討事項

反射背景のコストは、スクリーン上のピクセルに影響を及ぼすキャプチャの数のみに依存します。 
このシーンのディファード（遅延）ライティングにとても似ています。反射キャプチャは、影響を及ぼす半径に制約されるため、 
とても効率良くカリング処理されます。光沢はキューブマップミップマップを通じて実装されるため、 
シャープな反射とラフな質感の反射のパフォーマンスに多少の違いが生じます。

## 制限事項

*　このメソッドによる反射はおおよその結果です。具体的には、オブジェクトの反射はシンプルな形状への投影となるため、 
実際のシーンのオブジェクトとほとんど上手く調和しません。たくさんのキューブマップが一緒にブレンドされているため、 
多様なバージョンのオブジェクトを反射へ作成する傾向があります。鏡面反射の要因となる平面、滑らかなサーフェスは、 
エラーをはっきりと表示します。反射を分散させるために、 
詳細な法線マップとラフネスを使用します。
*　キューブマップへシーンをキャプチャするプロセスは、ゲームセッションの外で実行しなくてはいけないスローな処理です。つまり、 
静的シーンから反射を受け取ることはできるものの、動的オブジェクトを反射させることはできません。
*　エラーを削減するためにシーンのディフューズのみがキャプチャされます。純粋なスペキュラ サーフェス (メタル) は、キャプチャ中のディフューズであるかのようにスペキュラを適用します。
*　両サイドの壁で別々のライティング条件が使用されていると、かなりの漏れ光が発生します。 
片方の壁は正確な反射効果をもたらす設定にできますが、反射はもう片方の壁側へ常に漏れてしまいます。 
*DX11ハードウェアの制限により、シーンのキャプチャに使用するキューブマップは全て片側が128です。 
ワールドは一度に最大 341 の反射のキャプチャが可能です。

