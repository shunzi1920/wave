INTSourceChangelist:2311571
Availability:Docs
Title:フォグ ボリュームのユーザーガイド
Crumbs: %ROOT%, Engine, Engine/Actors, Engine/Actors/FogEffects
Description:体積ベースのフォグの作成、使用に関するガイド

[REGION:todo]
	このページはアンリアル エンジン 3 のドキュメントから転載され現在見直しがされています。古い情報が含まれる場合もありますので予めご了承ください。
[/REGION]

[TOC]



## バージョン

Fog volume は、QA_APPROVED_BUILD_MAR_2007 で導入されました。その後すぐに Fog Volume によってフォグが適用された透過処理のサポートが追加され、QA_APPROVED_BUILD_APRIL_2007 に含まれています。パーティクル フォグが QA_APPROVED_BUILD_MAY_2007 で使用可能になりました。クリッピング メッシュを伴う定数密度関数で同じような機能が利用できるため、定数高さ密度関数はこのビルドから削除されました。これにより、コンパイルされるシェーダ数が減少し、実際に効率が高まります。自動セットアップ方法は QA_APPROVED_BUILD_FEB_2008 で追加されました。それ以前は手動セットアップ方法のみサポートされていました。QA_APPROVED_BUILD_APR_2008 では、Fog Volume の負荷を含めるためにシェーダの複雑度が拡張されました。QA_APPROVED_BUILD_JUL_2008 では、密度設定 0 は、bEnabled=False と同じように扱われています。



## Fog Volume とは何か？

Fog Volume は、基本的に以下の 3 つから成り立っています。すなわち、フォグのフォールオフを制御する密度関数、密度関数をクリップするメッシュ、フォグの色を定義するマテリアルの 3 つです。Fog Volume は、[HeightFog](Engine/Actors/FogEffects/HeightFog) で利用可能な関数のスーパーセットです。Fog Volume は、メッシュにより結合されたり、複数の密度関数を操作し、カスタマイズ可能なマテリアルを使用できるからです。Fog Volume は、ボリューム内に入っていくカメラやボリュームに交差する不透明オブジェクトをシームレスに処理します。



## セットアップ方法

密度関数と、それをクリップするメッシュを関連付けるには自動と手動の 2 つの方法があります。 



## クイック自動セットアップ


* FogVolumeConstantDensityInfo を設定します (Generic Browser->Actor Classes->Info->FogVolumeDensityInfo にあります)。


![AutomaticConstDensityFogVolume.jpg](AutomaticConstDensityFogVolume.jpg)
_設定後の定数密度 Fog Volume_



## 自動セットアップの詳細

自動セットアップは、最も一般的に使用される結果を得るために、なるべく少ないクリック数でセットアップできるように設計されています。新しい Fog Volume 情報アクタを設置すると、スタティックメッシュ コンポーネントが自動的に追加され、Fog Volume をレンダリングするために使用されます。このコンポーネントは以下からアクセスできます。FogVolumeConstantDensityInfo->FogVolumeDensityInfo->AutomaticMeshComponentFog Volume 情報をスケーリングまたは回転する場合、Fog Volume に合わせて自動メッシュ コンポーネントもスケーリングまたは回転されます。これは、良好なパフォーマンスを得るために重要です。メッシュはシェーディングされるものであり、可視フォグ領域に密接にバインドされなければなりません。そうしないと、特に球体密度タイプでシェーディングの計算に無駄が生じます。 自動セットアップの追加詳細


* Fog volume 情報で DrawScale3d を1.0 から変更すると、AutomaticMeshComponent は Fog volume 情報のサイズと合わなくなります。
* 新しい球体 Fog volume 情報を配置すると、AutomaticMeshComponent が Fog volume 情報に密接に結合するように DrawScale X、 Y 、Z がセットアップされます。
* 以下を変更することで、Fog volume 情報に対して AutomaticMeshComponent の位置とスケーリングを制御することができます。AutomaticMeshComponent->PrimitiveComponent->Scale, Translation など
* 新しい Fog volume 情報を作成すると、レベルに新規マテリアルインスタンスが作成され、AutomaticMeshComponent に自動的に適用されます。これは、FogMaterial として設定されます。汎用ブラウザで選択しているマテリアルがある場合、そのマテリアルは親として使用されます。それ以外の場合は、EngineMaterials.FogVolumeMaterial が親になります。この新しいマテリアル インスタンスは、ユーザーが選択したマテリアルと互換性のある Fog Volume なら何にでも置換することができます。しかし、実際の Materials 配列を AutomaticMeshComponent で変更するのでなく、必ず情報アクタで FogMaterial を変更するようにしてください。
* Fog Volume 情報 の SimpleLightColor プロパティは、便利な特性であり、AutomaticMeshComponent のマテリアル インスタンスの 'EmissiveColor' ベクター パラメータとして設定されます。マテリアル インスタンスをオーバーライドして 'EmissiveColor' ベクター パラメータを使用しない場合は、SimpleLightColor は機能しなくなります。
* AutomaticMeshComponent は、手動で使用されるメッシュと違い、エディタで選択できないため、代わりに Fog Volume 情報アクタ自体を選択しなければいけません。
* AutomaticMeshComponent では、コリジョン、ライティング、シャドウイングのフラグのセットがすべて適切に設定されます。




## クイック手動セットアップ


* クローズしたスタティックメッシュを配置します。
* FogVolumeConstantDensityInfo を配置します (Generic Browser->Actor Classes->Info->FogVolumeDensityInfo にあります)。
* 新しく配置した Fog 情報の AutomaticMeshComponent をクリアします。
* スタティックメッシュを情報アクタの FogVolumeActors 配列に追加します。
    * これを行うには、まず配置した FogVolumeConstantDensityInfo のプロパティを開き、DensityComponent (密度コンポーネント) を展開します。
    * 左上のプロパティ ウィンドウのロックをクリックします。
    * ビューポートでスタティックメッシュを選択します。
    * ロックしたため、プロパティウィンドウには、なおも情報アクタが表示されています。  
    * [+] をクリックし、FogVolumeActors 配列にエントリを追加します。
    * 新しいエントリで、 'use selected Actor' ボタンをクリックします。


![SetFogVolumeActors.jpg](SetFogVolumeActors.jpg)
_FogVolumeActors 配列でスタティックメッシュを設定します。_

この時点で、スタティックメッシュは Fog Volume としてレンダリングされるはずです。  



## 手動セットアップの詳細


* 新しい FogVolumeActors エントリを追加すると、デフォルトの Fog Volume 設定でセットアップされます。これは、衝突、ライティング、シャドウイングを無効化します。新しい FogVolumeActor のメッシュ コンポーネント マテリアルも、EngineMaterials.FogVolumeMaterial を使用するように変更されます。これをオーバーライドするには、ターゲットの FogVolumeActor エントリにマテリアルを設定します。FogMaterial は手動セットアップでは使用されません。  **注記:プロパティ システムの制約上、現段階では新しいエントリを追加すると FogVolumeActors 配列のすべてのエントリがデフォルトに設定されます。**「最初に」 FogVolumeActors 配列内のすべてのエントリを設定してから、その後に必要に応じてマテリアルを設定するのが良いでしょう。
* 手動セットアップを使用すると、複数のメッシュを 1 つの Fog Volume 情報に関連付けることができます。また、情報やメッシュを別々にアニメーション化することもできます。しかし、複数のパーツをセットアップしアニメーション化するのは大変であるため、その場合は自動セットアップの方が簡単です。




## 密度関数

Fog Density 関数は、ワールドの様々な部分でのフォグの濃さを定義します。UE4 では、こうした密度関数は、FogVolumeDensityInfo アクタによって表されます。必ず、こうした関数のうちの 1 つを配置し、この関数は割り当てられた Fog Volumes アクタを持つようにしなければなりません。以下では、最も負荷が低いものから高い順に、様々な密度関数を紹介します。


### FogVolumeConstantDensityInfo

これは、あらゆる場所で同じ密度を持つ密度関数であり、密度変数により設定されます。

![ConstantDensityCube.jpg](ConstantDensityCube.jpg)
_定数密度関数でレンダリングされたキューブ。密度があらゆる場所で一定であるため、フォグ情報アクタの場所は重要ではありません。_


### FogVolumeLinearHalfspaceDensityInfo

密度関数はプレーンと線形密度係数により定義されます。プレーンの一面の半空間は、フォグがかかります。このプレーンは、情報アクタを回転したり移動したりすることで任意に回転させたり配置させたりすることができます。この関数の密度は、プレーンからの距離で線形に増加するため、プレーン上で密度は 0 になり、距離の値が 1 で、PlaneDistanceFactor になります。線形密度は、カメラがプレーン内にある時でも、半空間が決してハードエッジを形成しないようにします。

![LinearHalfspaceHeightfield.jpg](LinearHalfspaceHeightfield.jpg)
_キューブメッシュにより結合された線形半空間密度関数。密度はプレーンで 0 から始まり、この例では、XY プレーンに方向付けられたプレーンから遠ざかるほど増加します。ただし、これは、どの方向でも使用できます。_


### FogVolumeSphericalDensityInfo

球体密度関数は、MaxDensity (最大密度) の最大密度が中心にあり、その密度は球の半径で 0 の値に向って 4 方向にフォールオフし、スムーズ エッジを形成します。球体の中心は、情報アクタの位置により定義され、情報アクタをスケーリングすると、半径がスケーリングします。

![SphericalDensitySphere.jpg](SphericalDensitySphere.jpg)<br />
![SphericalDensitySphereClipped.jpg](SphericalDensitySphereClipped.jpg)
_スムーズエッジを持つ球体密度関数。球体をクリップしないため、第 1 の図で不可視になっているメッシュにより結合されます。第 2 の図では、メッシュが球体をクリップしています。プレビュー コンポーネントでは、ワイヤーフレームで球体密度関数の範囲が表示されます。


### 付加的な密度関数

これらの密度関数が、希望するフォールオフ エフェクトを作成するのに不十分な場合は、まずマテリアルを操作してみてください。例えば、よりソフトなエッジを希望する場合は、Fog Volume マテリアルでフレネルを球体に使用してみてください。   ポイントは、Fog Volume の背面のみがレンダリングされるため、ビューアー側に向かせるためには、従来のフレネル ノードの代わりに、法線をミラーリングしなければいけないところにあります。付加的な密度関数をコード内に追加することもできます。



## 付加的な設定

![FogVolumeInfoProperties.jpg](FogVolumeInfoProperties.jpg)
_FogVolumeSphericalDensityInfo のプロパティ_


### bEnabled 

Fog Volume を有効化 / 無効化するにはこのプロパティを使用します。


### StartDistance

フォグが始まるビューアーからの距離で、ワールド単位で表されます。これは現在、線形半空間密度関数ではサポートされていません。


### Density, PlaneDistanceFactor, MaxDensity

これらは、各密度タイプの Fog Volume 密度をコントロールします。これらのいずれかが 0 の値であるとき、機能的には bEnabled=False と同じです。



## Fog Volume アクタ

Fog Volume アクタは、実際にレンダリングされるものであり、密度関数をメッシュの内部にクリップします。**「クローズした」スタティック メッシュまたはスケルタル メッシュで機能します。**つまり、メッシュを通して投影される光線は、背面と同じ数だけ正面の数と交差しなければなりません。Xenon および shader model 2 PC 実装では、アーチファクトが出現するまでに、オーバーラップできる正面または背面の数が制限されています。現時点では、制限数は、背面、正面それぞれ、4 つのオーバーラップとなっています。



## Fog Volume マテリアル

Fog Volume アクタに割り当てたマテリアルは、以下の設定になっている必要があります。

* シェーディング モデルが 「Unlit」
* ブレンド モードが透過モードの内の一つに設定してある (Translucent、Additive または Modulative)。
* エミッシブ入力が必ず存在する。
* bUsedWithFogVolumes がチェックされている。このフラグは他の usage フラグに対して排他的であり、一度設定されると、Fog volume でのみマテリアルを使用できることに注意してください。


![MinimalMaterialSetup.jpg](MinimalMaterialSetup.jpg)
_最低限の Fog volume マテリアルのセットアップ「Opacity」(不透明度) がデフォルトで 1 になっているため、指定する必要はありません。


マテリアルのエミッシブ入力は Fog Volume カラーでありオパシティ入力は、Fog Volumes を介した距離から演算されるフォグの寄与をスケーリングします。


### マテリアルの制約

マテリアルを適用する際、Fog Volume アクタの背面のみが描かれます。これは、カメラが中にある状態でも Fog Volume が描かれるために必要となります。これは、テクスチャリングに密接に影響します。テクスチャは Fog Volume メッシュの背面のみに適用されます。これは、法線、リフレクション ベクタと言った他のメッシュの属性にも影響を与えます。  



## 高さフォグとの相互作用

Fog volume は高さフォグの影響を受けません。これは、高密度の高さフォグでアーティファクトを生じる場合があります。しかし、大きな Fog volume を使用する場合に、分けられる Fog volume で頂点毎の高さフォグを適用することが好ましいと言えます。交差する Fog Volume は、サポートされておらず、完全に、互いの前または後ろにあるかのように描画されます。



##Fog Volume での透過処理

Fog Volume は、透明なオブジェクトでソートされるため、透明なオブジェクトの完全に前、または後ろにある場合は正確に描画します。しかし、Fog Volume と交差する透明なオブジェクトは、最新のハードウェアではフォグが正確かつ効率的にかけられないため、近似値化されます。

**FogVolumeDensityInfo の ApproxFogLightColor を近似のマテリアル色に設定することが重要です。**これは、Fog Volume が交差する半透明のオブジェクトに適用する色です。  

![ApproxFogColor.jpg](ApproxFogColor.jpg)
_ApproxFogLightColor メンバを設定します。これにより、Fog Volume に交差している透明なオブジェクトにフォグが正確にかけられます。_


Fog Volume に交差している透明なオブジェクトには、以下の制約があります。

* フォグは、各頂点ごとに演算されます。アーチファクトを最小限にするには、透明メッシュのテッセレーションを増加し、大きな透過メッシュを避けます。
* Fog Volume メッシュからのクリッピングによるフォグの遷移は、表現されません。フォグのクリップには、Fog Volumes メッシュの軸に並行なバウンディング ボックスが代わりに使用されます。フォグ関数からのフォグ遷移 (すなわち、Spherical Density (球体密度) 関数における球体のエッジなど) は、正しく演算されます。
* 単一の透明なオブジェクトで近似値化できる最も多くのフォグの相互作用は、4 つの高さフォグ レイヤと 1 つの Fog Volume です。  
* 調整可能なブレンドモードを使用した透明なマテリアルには、高さフォグ、またはフォグ ボリュームのいずれによっても、まったくフォグが適用されません。  
* スキン メッシュに適用された透明なマテリアル(スケルタルメッシュまたはスケルタル メッシュのデカール) は、Fog Volume によってフォグがかけられません。


必要に応じて透過フォグ適用をオーバーライドできます。Fog volume から透過フォグ適用を無効にするには、FogVolumeDensityInfo を展開し bAffectsTranslucency のチェックを外してください。単一のマテリアルにフォグが適用されるのを防ぐためには、そのマテリアルに対して bAllowFog=false を設定します。



## パフォーマンスへの影響

一般的にひとつの Fog Volume は 1 層の透過処理よりも負荷が大きくなります。しかし、同じマテリアルとスクリーン エリアを持つ何十層もの透過処理よりは、はるかに負荷が小さくなります。パーティクル エフェクトを Fog Volume と置換する際、シェーダ複雑度ビューモードを使用して、相対的な負荷を把握しましょう。  

画面の 1 ピクセルのみをカバーしている、または完全に不透明なオブジェクトの後ろにあっても、レンダリングされる各 Fog Volume は、幾分オーバーヘッドを伴います。このため、同じボリュームを占めるのであれば、小さな Fog Volume を数多く持つよりも、1 つの大きな Fog Volume を 1 つ持つ方が良いことになります。Fog Volume メッシュは、いかなる閉じたメッシュにもなり得るので、フォグの開始場所と終了場所を完全にコントロールしつつ、1 つの Fog Volume をねじれたトンネルに使用することが可能です。

Fog Volumes は、最終結果を得るために複雑なピクセルシェーダーと、複数のパスを使用するため、完全にピクセル シェーダーに制約されます。つまり、非常にハイポリゴンの Fog Volumes を持つ、ほとんどのプラットフォームでは、パフォーマンスにまったく影響しません。また、これは、オーバードローが多い Fog Volume (正面や背面のオーバーラッピング) は、パフォーマンスが最悪になることを意味しています。

簡単なフォグ関数は、負荷が大きいものより速く実行します。例えば、定数密度関数は、球体密度関数より 2 倍の速さで実行します。できる限り、一番簡単なフォグ関数を使用してみてください。

Fog Volume アクタにあるすべてのピクセルは、どうフォグされるかということに関係なく同じ負荷であるため、できる限り一番小さいメッシュを使用するようにしてください。球体密度関数の例で言うと、球体の外側にはフォグが適用されませんが、メッシュが球体より大きい場合は、フォグが適用されていないピクセルであってもフォグが適用されたものと同じ負荷がかかります。球体関数をできるだけ近くに結合するため、メッシュのサイズを変えてください。自動セットアップ方法では、球体メッシュは球体関数を自動的に結合します。

以下の基準を満たしている場合、Fog Volume ではなく Fog Sheet を使用してください。

* オーバーラップしている Fog Sheet の数が少ない。
* カメラがフォグの中に入ることは決してない、またはフォグの中に入ったときにフォグが消えても構わない。
* 透過アイテムがフォグと交差しない、またはアーチファクトが顕著でない。


この場合、いかなる ノイズ テクスチャも Fog Sheet にマップできるため、Fog Sheet は Fog Volume よりも負荷が小さくなり、柔軟性があります。



## ベスト プラクティス

Fog Volume は、交差する透過の概算のみを行い、ネスティングをサポートしないため、小規模から中間のエフェクトで使用されるのが最適です。[HeightFog](Engine/Actors/FogEffects/HeightFog) レイヤを使用するか、その他のレベル全体のフォグ適用の方法、ライト周りまたはレベルの一部に含まれるボリュメトリック エフェクトのための Fog Volume を使用してください。

 




